# PNG 解码测试指南

## ✅ 编译状态
**编译时间**: 2026-02-22  
**编译结果**: ✅ 成功  
**固件大小**: 1843366 字节 (58.6% Flash)  
**内存使用**: 126288 字节 (38.5% RAM)

## 🚀 测试步骤

### 第一步：上传固件

在 VS Code 终端中运行：
```bash
C:\Users\ASUS\.platformio\penv\Scripts\platformio.exe run -t upload
```

或者使用 PlatformIO 侧边栏的"Upload"按钮。

### 第二步：打开串口监视器

上传完成后，立即打开串口监视器：
```bash
C:\Users\ASUS\.platformio\penv\Scripts\platformio.exe device monitor
```

或者使用 PlatformIO 侧边栏的"Monitor"按钮。

**波特率**: 115200（已在 platformio.ini 中配置）

### 第三步：连接 WiFi 热点

1. 等待 ESP32-S3 启动（约 5 秒）
2. 在手机或电脑上搜索 WiFi 热点：`ESP32-ImageDisplay`
3. 密码：`12345678`
4. 连接成功后，浏览器访问：`http://192.168.4.1`

### 第四步：上传 PNG 测试图片

1. 在 Web 控制台中，点击"选择文件"
2. 选择一张 PNG 图片（建议先测试小图片，如 100KB 以下）
3. 点击"上传"按钮
4. 等待上传完成

**推荐测试图片**:
- 标准 PNG（RGB 或 RGBA）
- 分辨率：240x320 或更小
- 文件大小：< 200KB
- 不使用隔行扫描（Interlaced）

### 第五步：显示 PNG 图片

1. 上传成功后，图片会出现在图片库中
2. 点击图片卡片上的"显示"按钮
3. 观察屏幕和串口日志

## 🔍 观察串口日志

### 成功案例（期望输出）

```
========== 开始加载 PNG 图片 ==========
文件路径: /uploaded/test.png

--- 尝试方法 1：文件回调方式 ---
PNG 回调：打开文件 /uploaded/test.png
✓ PNG 回调：文件已打开，大小: 85432 字节
✓ PNG 文件打开成功
  图片信息 - 宽: 240, 高: 320, 位深: 24
开始解码 PNG（文件回调方式）...
✓ PNG 图片显示完成（文件回调方式）
========================================
```

### 文件回调失败，内存方式成功

```
========== 开始加载 PNG 图片 ==========
文件路径: /uploaded/test.png

--- 尝试方法 1：文件回调方式 ---
PNG 回调：打开文件 /uploaded/test.png
✓ PNG 回调：文件已打开，大小: 85432 字节
✓ PNG 文件打开成功
  图片信息 - 宽: 240, 高: 320, 位深: 24
开始解码 PNG（文件回调方式）...
✗ PNG 解码失败（文件回调方式）
  错误码: -3
  尝试方法 2...

--- 尝试方法 2：内存方式 ---
文件大小: 85432 字节 (83.43 KB)
✓ 已从 PSRAM 分配文件缓冲区
✓ PNG 文件已完整读入内存，SD 卡总线已释放
开始解码 PNG（内存方式）...
✓ PNG 内存打开成功
  图片信息 - 宽: 240, 高: 320, 位深: 24
✓ PNG 图片显示完成（内存方式）
========================================
```

**说明**: 这也是成功的！内存方式更稳定，可以继续使用。

### 完全失败案例

```
========== 开始加载 PNG 图片 ==========
文件路径: /uploaded/test.png

--- 尝试方法 1：文件回调方式 ---
PNG 回调：打开文件 /uploaded/test.png
✓ PNG 回调：文件已打开，大小: 85432 字节
✗ PNG 文件打开失败（文件回调方式）
  错误码: -1
  原因: PNG_INVALID_FILE - 文件无效或不是 PNG 格式
  尝试方法 2...

--- 尝试方法 2：内存方式 ---
文件大小: 85432 字节 (83.43 KB)
✓ 已从 PSRAM 分配文件缓冲区
✓ PNG 文件已完整读入内存，SD 卡总线已释放
开始解码 PNG（内存方式）...
✗ PNG 内存打开失败
  错误码: -1
  原因: PNG_INVALID_FILE - 数据无效或不是 PNG 格式
  建议: 检查文件是否完整下载
========================================
```

**说明**: 两种方式都失败，说明 PNG 文件本身有问题。

## 📊 错误码对照表

| 错误码 | 宏定义 | 含义 | 可能原因 | 解决方案 |
|--------|--------|------|---------|---------|
| 0 | PNG_SUCCESS | 成功 | - | - |
| -1 | PNG_INVALID_FILE | 文件无效 | 文件损坏、不是 PNG 格式 | 重新保存 PNG，检查文件完整性 |
| -2 | PNG_MEM_ERROR | 内存错误 | PSRAM 不足 | 减小图片尺寸，检查 PSRAM 配置 |
| -3 | PNG_DECODE_ERROR | 解码错误 | PNG 数据损坏 | 使用标准 PNG 编码器重新保存 |
| -4 | PNG_UNSUPPORTED_FEATURE | 不支持的特性 | 隔行扫描、特殊色彩空间 | 取消隔行扫描，使用 RGB/RGBA |

## 🐛 常见问题排查

### 问题 1：屏幕黑屏，无任何日志

**可能原因**:
- ESP32-S3 未启动
- 串口监视器未连接
- 波特率设置错误

**解决方案**:
1. 检查 ESP32-S3 电源指示灯
2. 重新打开串口监视器
3. 确认波特率为 115200

### 问题 2：错误码 -1 (PNG_INVALID_FILE)

**可能原因**:
- PNG 文件在上传过程中损坏
- 文件不是标准 PNG 格式

**解决方案**:
1. 在电脑上打开 PNG 文件，确认文件完整
2. 使用十六进制编辑器检查文件头：
   ```
   89 50 4E 47 0D 0A 1A 0A
   ```
3. 使用 Photoshop 或 GIMP 重新保存为标准 PNG

### 问题 3：错误码 -2 (PNG_MEM_ERROR)

**可能原因**:
- PSRAM 未正常工作
- 图片文件过大

**解决方案**:
1. 检查 PSRAM 可用空间：
   ```cpp
   Serial.printf("PSRAM: %d 字节\n", ESP.getPsramSize());
   Serial.printf("可用: %d 字节\n", ESP.getFreePsram());
   ```
2. 减小图片尺寸或压缩图片
3. 确认 `platformio.ini` 中配置了 PSRAM：
   ```ini
   board_build.arduino.memory_type = qio_opi
   build_flags = -D BOARD_HAS_PSRAM
   ```

### 问题 4：错误码 -3 (PNG_DECODE_ERROR)

**可能原因**:
- PNG 数据损坏
- 不支持的压缩方式

**解决方案**:
1. 使用标准 PNG 编码器重新保存
2. 避免使用特殊的 PNG 选项
3. 尝试不同的 PNG 文件

### 问题 5：错误码 -4 (PNG_UNSUPPORTED_FEATURE)

**可能原因**:
- 使用了隔行扫描（Interlaced）
- 使用了特殊的色彩空间

**解决方案**:
1. 重新保存 PNG，取消"隔行扫描"选项
2. 使用 RGB 或 RGBA 色彩模式
3. 避免使用 PNG 扩展特性

## ✅ 测试清单

- [ ] 固件上传成功
- [ ] 串口监视器已连接（波特率 115200）
- [ ] WiFi 热点已连接
- [ ] Web 控制台可访问
- [ ] PNG 图片已上传
- [ ] 点击"显示"按钮
- [ ] 观察串口日志，记录错误码
- [ ] 根据错误码查找解决方案

## 📝 测试记录模板

```
测试时间: ____________________
PNG 文件名: __________________
文件大小: ____________________
分辨率: ______________________
错误码: ______________________
测试结果: [ ] 成功  [ ] 失败
备注: ________________________
```

## 🎯 下一步

根据测试结果：

1. **如果 PNG 显示成功**：
   - 恭喜！PNG 解码功能已正常工作
   - 可以测试更多不同的 PNG 图片
   - 可以测试自定义播放列表功能

2. **如果 PNG 显示失败**：
   - 记录完整的串口日志
   - 记录错误码
   - 参考 `PNG_DEBUG_GUIDE.md` 进行排查
   - 提供 PNG 文件的属性信息

---
**创建时间**: 2026-02-22  
**创建人**: Kiro  
**状态**: 待测试
