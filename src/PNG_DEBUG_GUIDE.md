# PNG 解码调试指南

## 🎯 调试目标

让 PNGdec 库"开口说话"，报告具体的错误码，精准定位 PNG 无法显示的原因。

## 🔧 已实现的调试功能

### 1. 双重解码策略

#### 方法 1：文件回调方式（推荐）
- 优点：内存占用小，适合大文件
- 缺点：需要正确实现文件回调函数

#### 方法 2：内存方式（备用）
- 优点：更稳定，避免文件回调问题
- 缺点：内存占用大

### 2. 详细的错误码输出

#### PNG 错误码对照表

| 错误码 | 宏定义 | 含义 | 可能原因 |
|--------|--------|------|---------|
| 0 | PNG_SUCCESS | 成功 | - |
| -1 | PNG_INVALID_FILE | 文件无效 | 文件损坏、不是 PNG 格式、文件不完整 |
| -2 | PNG_MEM_ERROR | 内存错误 | PSRAM 不足、内存分配失败 |
| -3 | PNG_DECODE_ERROR | 解码错误 | PNG 数据损坏、不支持的压缩方式 |
| -4 | PNG_UNSUPPORTED_FEATURE | 不支持的特性 | 特殊的 PNG 格式（如隔行扫描、特殊色彩空间） |

### 3. 完整的调试日志

#### 成功案例
```
========== 开始加载 PNG 图片 ==========
文件路径: /uploaded/test.png

--- 尝试方法 1：文件回调方式 ---
PNG 回调：打开文件 /uploaded/test.png
✓ PNG 回调：文件已打开，大小: 85432 字节
✓ PNG 文件打开成功
  图片信息 - 宽: 240, 高: 320, 位深: 24
开始解码 PNG（文件回调方式）...
✓ PNG 图片显示完成（文件回调方式）
========================================
```

#### 文件回调失败，内存方式成功
```
========== 开始加载 PNG 图片 ==========
文件路径: /uploaded/test.png

--- 尝试方法 1：文件回调方式 ---
PNG 回调：打开文件 /uploaded/test.png
✓ PNG 回调：文件已打开，大小: 85432 字节
✓ PNG 文件打开成功
  图片信息 - 宽: 240, 高: 320, 位深: 24
开始解码 PNG（文件回调方式）...
✗ PNG 解码失败（文件回调方式）
  错误码: -3
  尝试方法 2...

--- 尝试方法 2：内存方式 ---
文件大小: 85432 字节 (83.43 KB)
✓ 已从 PSRAM 分配文件缓冲区
✓ PNG 文件已完整读入内存，SD 卡总线已释放
开始解码 PNG（内存方式）...
✓ PNG 内存打开成功
  图片信息 - 宽: 240, 高: 320, 位深: 24
✓ PNG 图片显示完成（内存方式）
========================================
```

#### 完全失败案例
```
========== 开始加载 PNG 图片 ==========
文件路径: /uploaded/test.png

--- 尝试方法 1：文件回调方式 ---
PNG 回调：打开文件 /uploaded/test.png
✓ PNG 回调：文件已打开，大小: 85432 字节
✗ PNG 文件打开失败（文件回调方式）
  错误码: -1
  原因: PNG_INVALID_FILE - 文件无效或不是 PNG 格式
  尝试方法 2...

--- 尝试方法 2：内存方式 ---
文件大小: 85432 字节 (83.43 KB)
✓ 已从 PSRAM 分配文件缓冲区
✓ PNG 文件已完整读入内存，SD 卡总线已释放
开始解码 PNG（内存方式）...
✗ PNG 内存打开失败
  错误码: -1
  原因: PNG_INVALID_FILE - 数据无效或不是 PNG 格式
  建议: 检查文件是否完整下载
========================================
```

## 🔍 排查步骤

### 第一步：观察错误码

重新编译并上传固件：
```bash
pio run -t upload
pio device monitor
```

上传一张 PNG 图片，点击"显示"，观察串口输出的错误码。

### 第二步：根据错误码定位问题

#### 错误码 -1 (PNG_INVALID_FILE)

**可能原因**:
1. 文件不是标准的 PNG 格式
2. 文件在上传过程中损坏
3. 文件头部信息错误

**排查方法**:
1. 使用十六进制编辑器检查文件头
   - 标准 PNG 文件头：`89 50 4E 47 0D 0A 1A 0A`
2. 尝试在电脑上打开 PNG 文件，确认文件完整
3. 重新上传文件

**修复建议**:
```bash
# 在电脑上验证 PNG 文件
xxd -l 16 test.png
# 应该看到：89504e47 0d0a1a0a ...
```

#### 错误码 -2 (PNG_MEM_ERROR)

**可能原因**:
1. PSRAM 未正常工作
2. 内存不足
3. 内存分配失败

**排查方法**:
1. 检查 PSRAM 是否正常
   ```cpp
   Serial.printf("PSRAM 大小: %d 字节\n", ESP.getPsramSize());
   Serial.printf("PSRAM 可用: %d 字节\n", ESP.getFreePsram());
   ```
2. 检查图片文件大小
3. 尝试更小的 PNG 文件

**修复建议**:
- 确认 `platformio.ini` 中配置了 PSRAM
  ```ini
  board_build.arduino.memory_type = qio_opi
  build_flags = -D BOARD_HAS_PSRAM
  ```
- 减小图片尺寸或压缩图片

#### 错误码 -3 (PNG_DECODE_ERROR)

**可能原因**:
1. PNG 数据损坏
2. 不支持的压缩方式
3. 文件回调函数返回错误数据

**排查方法**:
1. 检查文件回调函数是否正确实现
2. 观察 PNG 回调日志，查看读取是否正常
3. 尝试使用标准的 PNG 编码器重新保存图片

**修复建议**:
- 使用 Photoshop 或 GIMP 重新保存 PNG
- 选择"标准 PNG"格式，不使用特殊选项

#### 错误码 -4 (PNG_UNSUPPORTED_FEATURE)

**可能原因**:
1. 使用了隔行扫描（Interlaced）
2. 使用了特殊的色彩空间
3. 使用了不支持的 PNG 扩展

**排查方法**:
1. 使用图片查看器检查 PNG 属性
2. 查看是否使用了隔行扫描

**修复建议**:
- 重新保存 PNG，取消"隔行扫描"选项
- 使用 RGB 或 RGBA 色彩模式
- 避免使用 PNG 扩展特性

### 第三步：文件回调调试

如果文件回调方式失败，检查以下内容：

#### 1. 文件打开
```
PNG 回调：打开文件 /uploaded/test.png
✓ PNG 回调：文件已打开，大小: 85432 字节
```
- 如果看到"无法打开文件"，检查文件路径是否正确

#### 2. 文件读取
```
⚠️ PNG 回调：读取 1024 字节，实际 512 字节
```
- 如果看到读取字节数不匹配，可能是 SD 卡问题

#### 3. 文件定位
```
✗ PNG 回调：定位到 2048 失败
```
- 如果看到定位失败，可能是文件句柄问题

### 第四步：内存方式调试

如果内存方式也失败，检查以下内容：

#### 1. 内存分配
```
✓ 已从 PSRAM 分配文件缓冲区
```
- 如果看到"PSRAM 分配失败"，检查 PSRAM 配置

#### 2. 文件读取
```
✓ PNG 文件已完整读入内存，SD 卡总线已释放
```
- 如果看到读取失败，检查 SD 卡是否正常

#### 3. 解码
```
✗ PNG 解码失败（内存方式）
  错误码: -1
```
- 如果解码失败，说明 PNG 文件本身有问题

## 🛠️ 常见问题解决方案

### 问题 1：所有 PNG 都显示错误码 -1

**解决方案**:
1. 检查 PNG 文件是否完整
2. 尝试重新下载或重新保存 PNG
3. 使用在线 PNG 验证工具检查文件

### 问题 2：文件回调方式失败，内存方式成功

**解决方案**:
- 这是正常的，说明文件回调函数可能有小问题
- 内存方式更稳定，可以继续使用

### 问题 3：两种方式都失败，错误码 -2

**解决方案**:
1. 检查 PSRAM 是否正常工作
   ```cpp
   Serial.printf("PSRAM: %d 字节\n", ESP.getPsramSize());
   ```
2. 减小图片尺寸
3. 释放其他占用的内存

### 问题 4：JPEG 正常，PNG 全部失败

**解决方案**:
1. 检查 PNGdec 库是否正确安装
2. 检查 `platformio.ini` 中的依赖
   ```ini
   lib_deps = bitbank2/PNGdec @ ^1.0.1
   ```
3. 清理并重新编译
   ```bash
   pio run -t clean
   pio run
   ```

## 📝 调试清单

- [ ] 重新编译并上传固件
- [ ] 上传测试 PNG 文件
- [ ] 观察串口日志，记录错误码
- [ ] 根据错误码查找对应的解决方案
- [ ] 检查 PNG 文件是否完整
- [ ] 检查 PSRAM 是否正常工作
- [ ] 尝试不同的 PNG 文件
- [ ] 尝试重新保存 PNG（标准格式）

## 🚀 下一步

根据串口日志中的错误码，按照上述步骤逐一排查。如果问题仍然存在，请提供：
1. 完整的串口日志
2. PNG 文件的属性信息
3. PSRAM 可用空间信息

---
**创建时间**: 2026-02-22  
**创建人**: Kiro
