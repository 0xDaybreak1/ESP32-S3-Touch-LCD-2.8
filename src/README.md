# 源代码说明文档

## 最近修改记录

### 2026-02-22 - 修复 SD 卡与 TFT 共享总线冲突 (Kiro)

**修改内容:**
1. 修改 JPEG 解码流程: 先将整个文件读入内存,关闭 SD 卡文件,再解码显示
2. 修改 PNG 解码流程: 使用 `openRAM()` 从内存解码,避免回调中访问 SD 卡
3. 修改 BMP 解码流程: 先读取所有像素数据到内存,关闭文件后再处理显示

**问题原因:**
- SD_MMC 和 TFT 虽然使用不同接口 (SDMMC vs SPI),但在解码回调中交替访问会导致总线冲突
- 原代码在解码过程中持续打开 SD 卡文件,每次回调都要读取数据
- 这导致 SD 卡的片选信号和 TFT 的片选信号冲突,造成白屏或花屏

**解决方案:**
- **先读后显**: 完整读取图片文件到内存 → 关闭 SD 卡文件 → 从内存解码并显示
- **总线隔离**: 确保 SD 卡访问和 TFT 访问不会同时进行
- **内存管理**: 使用动态内存分配,用完立即释放

**编译结果:**
- ✅ 编译成功
- RAM 使用: 38.3% (125,352 / 327,680 字节)
- Flash 使用: 62.8% (1,973,954 / 3,145,728 字节)

### 2026-02-22 - 修复编译错误 (Kiro)

**修改内容:**
1. 在 `Display_ST7789.h` 中添加了 `LCD_WriteData_nbyte` 函数声明
2. 修正了 `Image_Decoder.cpp` 中 PNG 回调函数的 PNGDRAW 结构体成员访问
   - 将 `pDraw->iX` 和 `pDraw->iY` 改为 `pDraw->y`
   - 使用 `pDraw->iWidth` 获取宽度
3. 修正了 `Image_Decoder.h` 中 JPEG 回调函数的签名

**问题原因:**
- `LCD_WriteData_nbyte` 函数在 `.cpp` 中实现但未在 `.h` 中声明,导致链接错误
- PNGDRAW 结构体实际成员名为 `y` 和 `iWidth`,而非 `iX`/`iY`/`x`

## 模块说明

### Image_Decoder (图片解码器)
- 支持 JPEG、PNG、BMP 三种格式
- JPEG: 使用 TJpg_Decoder 库,从内存缓冲区解码
- PNG: 使用 PNGdec 库,从内存缓冲区解码
- BMP: 手动解析文件头和像素数据,从内存缓冲区处理

**关键特性:**
- 先读后显策略,避免 SD 卡和 TFT 总线冲突
- 动态内存管理,根据文件大小分配缓冲区
- RGB565 颜色格式,适配 ST7789 显示屏

### Display_ST7789 (显示驱动)
- ST7789 LCD 驱动程序
- 分辨率: 240×320
- 支持 RGB565 颜色格式
- SPI 接口,80MHz 频率
